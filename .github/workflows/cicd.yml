name: CI/CD Pipeline

on:
  workflow_dispatch

jobs:
  ssh-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install SSHpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: SSH into server and deploy app
        env:
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          SSH_IP: ${{ secrets.SSH_IP }}
          REPO_URL: ${{ secrets.REPO_URL }}
        run: |
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no "$SSH_USERNAME@$SSH_IP" "
            sudo apt update && sudo apt install -y nginx &&
            sudo systemctl enable nginx &&
            sudo systemctl start nginx &&

            if [ -d '/var/www/shopdesk-fe' ]; then
              cd /var/www/shopdesk-fe && git pull origin main
            else
              sudo git clone $REPO_URL /var/www/shopdesk-fe
              sudo chown -R $USER:$USER /var/www/shopdesk-fe
            fi &&

            echo 'Building frontend...' &&
            cd /var/www/shopdesk-fe &&
            npm install &&
            npm run build &&

            echo 'Configuring NGINX...' &&
            sudo bash -c 'cat > /etc/nginx/sites-available/shopdesk-fe << EOF
            server {
              listen 7777;
              server_name _;

              location / {
                proxy_pass http://localhost:3000;  # Forward to your app's port
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$scheme;
              }
            }
            EOF' &&

            sudo ln -sf /etc/nginx/sites-available/shopdesk-fe /etc/nginx/sites-enabled/ &&
            sudo nginx -t &&
            sudo systemctl restart nginx &&
            echo 'Deployment completed. Your site is live on port 7777!'
          "