name: CI/CD Pipeline

on:
  workflow_dispatch

jobs:
  ssh-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install SSHpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: SSH into server and deploy app
        env:
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          SSH_IP: ${{ secrets.SSH_IP }}
          REPO_URL: ${{ secrets.REPO_URL }}
        run: |
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no "$SSH_USERNAME@$SSH_IP" "
            # Clone or update the repository
            if [ -d 'shopdesk-fe' ]; then
              cd shopdesk-fe && git pull origin main
            else
              git clone $REPO_URL shopdesk-fe
            fi &&

            # Install dependencies and build the app
            echo 'Building frontend...' &&
            cd shopdesk-fe &&
            npm install &&
            npm run build &&

            # Start the app on a non-privileged port (e.g., 3000)
            echo 'Starting application...' &&
            nohup npm run dev > /dev/null 2>&1 &

            # Configure a reverse proxy (e.g., using a user-space tool like 'serve' or 'http-server')
            echo 'Starting reverse proxy on port 7777...' &&
            npm install -g serve &&
            nohup serve -l 7777 -s dist > /dev/null 2>&1 &

            echo 'Deployment completed. Your site is live on port 7777!'
          "